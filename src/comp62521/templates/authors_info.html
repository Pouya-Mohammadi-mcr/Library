{% extends "base.html" %}
{% block title %}{{ args.title }}{% endblock %}
{% block content %}

<h1>{{ args.title }}</h1>

<table id="table1">
  <thead>
    <tr>
    {% for column in args.data[0] %}
      <th>{{ column }}</th>
    {% endfor %}
    </tr>
  </thead>

  <tbody>
  {% for row in args.data[1] %}
    <tr>
    {% for data_item in row %}
      <td>{{ data_item }}</td>
    {% endfor %}
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
  $(document).ready(function() {
    $('#table1').DataTable( {      
        'sorting': false,
        'search': true,
        'paging': false
    
    } );
  } );
</script>
<script type="text/javascript">
  header_arr = [];
  asc = false; // low - high
  const getCellValue = (tr, idx) =>
    tr.children[idx].innerText || tr.children[idx].textContent;

  var comparer = function (idx, asc, col_name) {
    return function (a, b) {
      return (function (v1, v2) {
        if (col_name == "Author") {
          v1_lastname = v1.split(/[\s,]+/).pop();
          v2_lastname = v2.split(/[\s,]+/).pop();
          
          numLastname1 = parseInt(v1_lastname.toString());
          numLastname2 = parseInt(v2_lastname.toString());

          if (isNaN(numLastname1) == false) {
            v1_lastname = v1.split(/[\s,]+/).slice(-2, -1)[0];
          }
          if (isNaN(numLastname2) == false) {
            v2_lastname = v2.split(/[\s,]+/).slice(-2, -1)[0];
          }
          return v1_lastname !== "" &&
            v2_lastname !== "" &&
            !isNaN(v1_lastname) &&
            !isNaN(v2_lastname)
            ? v1_lastname - v2_lastname
            : v1_lastname.toString().localeCompare(v2_lastname);
        } else {
          return v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2)
            ? v1 - v2
            : v1.toString().localeCompare(v2);
        }
      })(getCellValue(asc ? b : a, idx), getCellValue(asc ? a : b, idx));
    };
  };

  document.querySelectorAll("th").forEach((th) =>
    th.addEventListener("click", () => {
      const table = th.closest("table");
      const tbody = table.querySelector("tbody");
      header = Array.from(th.parentNode.children).indexOf(th);
      col_name =
        Array.from(th.parentNode.children)[header].innerText ||
        Array.from(th.parentNode.children)[header].textContent;
      if (header_arr.length == 0) {
        header_arr.push(header);
        asc = true;
      } else {
        if (header_arr.includes(header)) {
          // click the same col
          asc = false; // toggle
          header_arr.pop();
        } else {
          // click a new col
          asc = true;
          header_arr.pop();
          header_arr.push(header);
        }
      }
      Array.from(tbody.querySelectorAll("tr"))
        .sort(comparer(header, asc, col_name))
        .forEach((tr) => tbody.appendChild(tr));
    })
  );
</script>


{% endblock %}
